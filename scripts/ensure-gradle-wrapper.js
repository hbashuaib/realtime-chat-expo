// scripts/ensure-gradle-wrapper.js
const fs = require('fs');
const path = require('path');

const androidDir = path.join(process.cwd(), 'android');
const gradlewPath = path.join(androidDir, 'gradlew');
const wrapperDir = path.join(androidDir, 'gradle', 'wrapper');
const jarPath = path.join(wrapperDir, 'gradle-wrapper.jar');
const propsPath = path.join(wrapperDir, 'gradle-wrapper.properties');

// Minimal POSIX gradlew script (LF line endings)
const gradlewContent =
`#!/usr/bin/env sh
# Generated by ensure-gradle-wrapper.js if missing
# Find java and exec Gradle wrapper
APP_HOME=$(cd "$(dirname "$0")" && pwd)
JAVA_EXE=java
exec "$JAVA_EXE" -Dorg.gradle.appname=gradlew -classpath "$APP_HOME/gradle/wrapper/gradle-wrapper.jar" org.gradle.wrapper.GradleWrapperMain "$@"
`;

function ensureFile(p, content) {
  fs.writeFileSync(p, content.replace(/\r\n/g, '\n'), { encoding: 'utf8' });
}

function ensureGradlew() {
  if (!fs.existsSync(gradlewPath)) {
    if (!fs.existsSync(androidDir)) {
      throw new Error('android/ directory not found. Ensure native project exists before build.');
    }
    console.log('Creating android/gradlew...');
    ensureFile(gradlewPath, gradlewContent);
    // chmod +x
    fs.chmodSync(gradlewPath, 0o755);
    console.log('Marked android/gradlew as executable.');
  } else {
    // Ensure LF and executable
    const buf = fs.readFileSync(gradlewPath, 'utf8');
    ensureFile(gradlewPath, buf);
    fs.chmodSync(gradlewPath, 0o755);
    console.log('Verified android/gradlew exists and is executable.');
  }
}

function checkWrapperJarAndProps() {
  if (!fs.existsSync(wrapperDir)) {
    fs.mkdirSync(wrapperDir, { recursive: true });
  }
  const missing = [];
  if (!fs.existsSync(jarPath)) missing.push('gradle-wrapper.jar');
  if (!fs.existsSync(propsPath)) missing.push('gradle-wrapper.properties');

  if (missing.length) {
    console.warn(`Warning: Missing ${missing.join(', ')} in android/gradle/wrapper.`);
    console.warn('These should be committed to the repo. Build may fail if the JAR is absent.');
  } else {
    console.log('Found gradle/wrapper JAR and properties.');
  }
}

ensureGradlew();
checkWrapperJarAndProps();
console.log('ensure-gradle-wrapper: done');